services:
  elasticsearch:
    container_name: temporal-elasticsearch
    image: elasticsearch:7.17.18
    environment:
      - cluster.name=temporal-elasticsearch
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
      - xpack.monitoring.enabled=false
      - xpack.graph.enabled=false
      - xpack.watcher.enabled=false
      - xpack.ml.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
    networks:
      - xians-community-edition
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1g
        reservations:
          memory: 512m

  temporal:
    container_name: temporal
    external_links:
      - postgresql:postgresql
    env_file:
      - .env.local
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PWD=${POSTGRES_PASSWORD}
      - POSTGRES_SEEDS=postgresql
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-es.yaml
      - ENABLE_ES=true
      - ES_SEEDS=elasticsearch
      - ES_VERSION=v7
      - ES_VIS_INDEX=temporal_visibility_v1_dev
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CLI_ADDRESS=temporal:7233
    depends_on:
      elasticsearch:
        condition: service_healthy
    # This image runs ALL temporal services (frontend, matching, history, worker) in single process
    image: temporalio/auto-setup:${TEMPORAL_VERSION}
    networks:
      - xians-community-edition
    ports:
      - 7233:7233
    volumes:
      - ./dynamicconfig:/etc/temporal/config/dynamicconfig
  # Removed temporal-admin-tools - not needed with auto-setup image
  # You can access admin tools by running: docker exec -it temporal tctl cluster health
  temporal-ui:
    container_name: temporal-ui
    depends_on:
      - temporal
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_AUTH_ENABLED=true
      - TEMPORAL_AUTH_PROVIDER_URL=${AUTH_HOST}/realms/xiansai
      - TEMPORAL_AUTH_ISSUER_URL=${AUTH_HOST}/realms/xiansai
      - TEMPORAL_AUTH_CLIENT_ID=temporal-ui
      - TEMPORAL_AUTH_CLIENT_SECRET=${TEMPORAL_UI_CLIENT_SECRET}
      - TEMPORAL_AUTH_CALLBACK_URL=${TEMPORAL_HOST}/auth/sso/callback
      - TEMPORAL_AUTH_SCOPES=openid,profile,email
    image: temporalio/ui:${TEMPORAL_UI_VERSION}
    networks:
      - xians-community-edition
    ports:
      - 8080:8080
networks:
  xians-community-edition:
    external: true
    name: xians-community-edition-network

volumes:
  elasticsearch_data:
    name: temporal-elasticsearch-data
    driver: local
